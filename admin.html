<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helpdesk · Admin</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#f7f8fb}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:#fff;border-bottom:1px solid #e8edf3}
    header .right{display:flex;gap:8px;align-items:center}
    main{max-width:1200px;margin:20px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e8edf3;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f6;font-size:.95rem;vertical-align:top}
    th{background:#f3f6fb;text-align:left}
    select,input[type=text]{padding:.4rem .5rem;border:1px solid #ccd3db;border-radius:8px}
    button{padding:.45rem .7rem;border:1px solid #d4dbe6;border-radius:8px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div><strong>Helpdesk · Admin</strong></div>
    <div class="right">
      <span id="who"></span>
      <button id="logout">Logout</button>
    </div>
  </header>

  <main>
    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th><th>Date &amp; Time Raised</th><th>Flat</th><th>Issue</th>
          <th>Status</th><th>Redressal Remark</th><th>Save</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script type="module">
    import { requireAuth, apiPost, signOut } from './app.js';

    const fmt = (v)=> (v===undefined||v===null||v==='') ? '—' : v;

    async function load() {
      const info = await requireAuth();
      if (!info) return;
      if ((info.role||'').toLowerCase() !== 'admin') {
        alert('Admin only'); window.location.replace('/index.html'); return;
      }
      document.getElementById('who').textContent = `${info.user || 'Admin'} (${info.role||'admin'})`;

      const r = await apiPost('data', {}, false);
      if (!r || !r.ok) { alert(r?.error || 'Failed to load data'); return; }

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      for (const row of r.data || []) {
        const tr = document.createElement('tr');
        const id = row.TrackingID;

        tr.innerHTML = `
          <td>${fmt(id)}</td>
          <td>${fmt(row.DateTimeRaised)}</td>
          <td>${fmt(row.Flat)}</td>
          <td>${fmt(row.Issue)}</td>
          <td>
            <select data-sel="${id}">
              ${['Open','In Progress','Resolved'].map(s=>`<option ${String(row.Status).toLowerCase()===s.toLowerCase()?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" data-rem="${id}" value="${(row.RedressalRemark||'').toString().replace(/"/g,'&quot;')}" placeholder="Add remark" /></td>
          <td><button data-save="${id}">Save</button></td>
        `;
        tbody.appendChild(tr);
      }

      tbody.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-save');
        if (!id) return;
        const sel = tbody.querySelector(`[data-sel="${id}"]`);
        const inp = tbody.querySelector(`[data-rem="${id}"]`);
        const status = sel.value;
        const remark = inp.value.trim();

        const resp = await apiPost('update', { id, status, remark }, true);
        if (!resp || !resp.ok) { alert(resp?.error || 'Update failed'); return; }
        alert('Saved');
      });
    }

    document.getElementById('logout').addEventListener('click', signOut);
    load();
  </script>
</body>
</html>
