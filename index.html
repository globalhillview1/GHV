<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helpdesk Dashboard</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#f7f8fb}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:#fff;border-bottom:1px solid #e8edf3}
    header .right{display:flex;gap:8px;align-items:center}
    main{max-width:1200px;margin:20px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e8edf3;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f6;font-size:.95rem}
    th{background:#f3f6fb;text-align:left}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid #dbe4ee;font-size:.8rem}
    .metrics{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:16px}
    .k{background:#fff;border:1px solid #e8edf3;border-radius:12px;padding:12px}
    button{padding:.5rem .8rem;border:1px solid #d4dbe6;border-radius:10px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div><strong>Global Hillview · Helpdesk</strong></div>
    <div class="right">
      <span id="who"></span>
      <button id="logout">Logout</button>
    </div>
  </header>

  <main>
    <section class="metrics">
      <div class="k"><div>Total</div><h2 id="k-total">—</h2></div>
      <div class="k"><div>Open</div><h2 id="k-open">—</h2></div>
      <div class="k"><div>In Progress</div><h2 id="k-inprog">—</h2></div>
      <div class="k"><div>Resolved</div><h2 id="k-res">—</h2></div>
    </section>

    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th><th>Date &amp; Time Raised</th><th>Tower</th><th>Flat</th>
          <th>Issue</th><th>Description</th><th>Status</th><th>User ID</th>
          <th>Date &amp; Time Resolved</th><th>Time Taken</th><th>Feedback</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script type="module">
    import { requireAuth, apiPost, signOut } from './app.js';

    const fmt = (v)=> (v===undefined||v===null||v==='') ? '—' : v;

    async function load() {
      const info = await requireAuth();
      if (!info) return;
      document.getElementById('who').textContent = `${info.user || 'User'} (${info.role||'user'})`;

      // Get data
      const r = await apiPost('data', {}, false); // 'data' is open in your GAS; if you want to require auth, set includeToken=true
      if (!r || !r.ok) { alert(r?.error || 'Failed to load data'); return; }

      const rows = r.data || [];
      // simple metrics
      const total = rows.length;
      const open = rows.filter(x=> String(x.Status||'').toLowerCase()==='open').length;
      const inprog = rows.filter(x=> String(x.Status||'').toLowerCase().includes('progress')).length;
      const resolved = rows.filter(x=> String(x.Status||'').toLowerCase()==='resolved').length;
      document.getElementById('k-total').textContent = total;
      document.getElementById('k-open').textContent = open;
      document.getElementById('k-inprog').textContent = inprog;
      document.getElementById('k-res').textContent = resolved;

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmt(r.TrackingID)}</td>
          <td>${fmt(r.DateTimeRaised)}</td>
          <td>${fmt(r.Tower)}</td>
          <td>${fmt(r.Flat)}</td>
          <td>${fmt(r.Issue)}</td>
          <td>${fmt(r.Description)}</td>
          <td><span class="pill">${fmt(r.Status)}</span></td>
          <td>${fmt(r.UserID)}</td>
          <td>${fmt(r.DateTimeResolved)}</td>
          <td>${fmt(r.TimeTaken)}</td>
          <td>${fmt(r.Feedback)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('logout').addEventListener('click', signOut);
    load();
  </script>
</body>
</html>
