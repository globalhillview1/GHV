<!DOCTYPE html>

<html>
<head>
<base target="_top">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login | Helpdesk</title>
<style>
:root{
--card:#ffffff; --bg:#f7f9fc; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a; --blue:#0d6efd; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg); color:var(--text);}
.wrap{min-height:100vh; display:grid; place-items:center; padding:24px;}
.card{width:100%; max-width:420px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,.06)}
h1{font-size:22px; margin:0 0 8px}
p{color:var(--muted); margin:0 0 18px}
label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
input{width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:8px; font-size:16px; outline:none; transition:border-color .2s}
input:focus{border-color:var(--blue)}
button{width:100%; background:var(--blue); color:white; padding:12px 14px; border:none; border-radius:8px; font-size:16px; cursor:pointer; transition:background-color .2s}
button:hover:not(:disabled){background:#0a58ca}
button:disabled{background:#a9c5f8; cursor:not-allowed}
.err{color:var(--danger); background:#fee2e2; border:1px solid #fca5a5; padding:12px; border-radius:8px; margin-top:16px; display:none}
.spinner{display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="wrap">
<div class="card">
<h1>Helpdesk Login</h1>
<p>Enter your credentials to access the dashboard.</p>

  <form id="loginForm" onsubmit="event.preventDefault(); submit();">
    <label for="u">Username</label>
    <input type="text" id="u" placeholder="username" required>
    
    <label for="p">Password</label>
    <input type="password" id="p" placeholder="password" required>
    
    <button id="btn" type="submit">
      <span id="spin" class="spinner" style="display:none;"></span>
      <span id="label">Sign in</span>
    </button>
  </form>

  <div id="err" class="err"></div>
</div>


</div>

<script>
const btn = document.getElementById('btn');
const label = document.getElementById('label');
const spin = document.getElementById('spin');

// The API URL is now the local proxy path!
const API_URL = &#39;/api/&#39;; 

// --- Helper Functions ---
function showErr(msg){
  const err = document.getElementById(&#39;err&#39;);
  err.textContent = msg;
  err.style.display = &#39;block&#39;;
}

function setLoading(on){
  btn.disabled = !!on;
  btn.setAttribute(&#39;aria-busy&#39;, on ? &#39;true&#39; : &#39;false&#39;);
  label.textContent = on ? &#39;Signing inâ€¦&#39; : &#39;Sign in&#39;;
  spin.style.display = on ? &#39;inline-block&#39; : &#39;none&#39;;
}

// --- Main Login Logic using Fetch ---
async function submit(){
  if (btn.disabled) return;
  const username = document.getElementById(&#39;u&#39;).value.trim();
  const password = document.getElementById(&#39;p&#39;).value;
  document.getElementById(&#39;err&#39;).style.display = &#39;none&#39;;
  setLoading(true);

  const payload = {
      op: &quot;login&quot;, // Operation code for doPost
      username: username,
      password: password
  };

  try {
      const response = await fetch(API_URL, {
          method: &#39;POST&#39;,
          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
          body: JSON.stringify(payload)
      });

      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      // Handle successful login
      if(result &amp;&amp; result.ok &amp;&amp; result.redirect){
          // Persist session token so dashboard can recover it
          try {
              const url = new URL(result.redirect);
              const token = url.searchParams.get(&#39;session&#39;);
              if (token) localStorage.setItem(&#39;session&#39;, token);
          } catch(e){
              console.error(&quot;Error parsing session token from redirect URL:&quot;, e);
          }
          window.location.replace(result.redirect);
      } else {
          setLoading(false);
          showErr(result &amp;&amp; result.error ? result.error : &quot;Login failed (Invalid credentials).&quot;);
      }

  } catch (error) {
      setLoading(false);
      console.error(&quot;Fetch Error:&quot;, error);
      showErr(`Network Error: Failed to connect to API or invalid response. Details: ${error.message}`);
  }
}


</script>

</body>
</html>
